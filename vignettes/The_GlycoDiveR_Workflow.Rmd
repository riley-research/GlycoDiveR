---
title: "The GlycoDiveR Workflow"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 4
    toc_float: false
vignette: >
  %\VignetteIndexEntry{Basic GlycoDiveR Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette provides the basics of using GlycoDiver. It will showcase the defaults
for numerous graphs. For further reading please refer to the Github and for insights
on specific functions type ? followed by the function name (?ImportMSFragger) in 
R after loading GlycoDiveR.

## Installing and loading GlycoDiveR

You can install and load the development version of GlycoDiveR from GitHub with:

``` {r, eval = FALSE}
if (!requireNamespace("GlycoDiveR", quietly = TRUE)) {
  devtools::install_github("riley-research/GlycoDiveR", build_vignettes = TRUE)
}
```

```{r, message=FALSE, warning=FALSE, eval = FALSE}
library(GlycoDiveR)
```
```{r, echo=FALSE, message=FALSE}
devtools::load_all()
```

To follow this vignette, you can use the raw data uploaded on GlycoDiver's Github,
but is also pre-loaded, so you don't have to follow the first few steps. If you want
to use the pre-loaded data run the following code:

```{r}
data("exampleData")
```

## Importing search engine outputs

GlycoDiveR can directly import output from MSFragger (including N-glycopeptide 
searches and O-glycopeptide searches with or without OPair), Byonic, and pGlyco.
It is also directly compatible with data processed using MSstats or Perseus (see 
the GitHub for details).

It is important that GlycoDiveR interfaces with untouched search engine outputs.
Any manual changes might break the importer.

Every importer needs the following three things to import data:

- An annotation file
- The untouched search engine output
- The fasta file used for the search, this means including contaminants and decoys
for MSFragger searches

### Generating the annotation file

The annotation file is used to specify which runs belong to which condition, 
assign biological replicates, and assign technical replicates.

The annotation file template is automatically generated by running the following
code.

```{r setup, eval = FALSE}
GetAnnotationTemplate(path = "C:/pathToFolder", tool = "MSFragger")
```

It will find all `psm.tsv` files in the listed folder AND all the sub folders. Additionally,
it will identify all `combined_peptide.tsv` files if FragPipe computed
normalized intensities are used.

**Important note**: when importing MSFragger output, it is important that you have
correctly supplied Experiment names in, for example, FragPipe. In FragPipe this
is done in the Workflow tab. It is always a safe bet to have a unique Experiment
name for each sample. If you don't, there might be issues.

An annotation.csv file will be generated. Fill in the annotation file as shown below.
Make sure to use unique names in the Alias column.

```{r echo=FALSE}
print(data.frame(Run = c("Run_Treated_1", "Run_Treated_2", "Run_Untreated_1", "Run_Untreated_2"),
                 Alias = c("Treated_1", "Treated_2", "Untreated_1", "Untreated_2"),
                 Condition = as.character(c("Treated","Treated", "Untreated", "Untreated")),
                 BioReplicate = c(1,2,1,2),
                 TechReplicate = c(1,1,1,1)))

```

### Importing the search engine output

Each importer has numerous arguments that control for the desired cutoffs (e.g.
peptide and glycan score cutoffs, and localization confidence), normalization
options, and more. Please take the time to read the docs of the importer you are
using.

```{r, eval = FALSE}
?ImportMSFragger

exampleData <- ImportMSFragger(path = "C:/pathToFolder",
                       annotation = "C:/pathToFolder/annotation.csv",
                       fastaPath = "C:/pathToFolder/database-decoys-contam.fasta.fas",
                       normalization = "median",
                       peptideScoreCutoff = 0,
                       glycanScoreCutoff = 0.01)
```

### Importing comparison results

GlycoDiveR can compute log2 fold-changes, p values, and FDR values; however,
for more detailed control please use Perseus or MSstats, and use GlycoDiveR's
importers to import those results (see the Github wiki how to do this).

Each of the options to get comparison results will return a dataframe with the
results.

```{r}
myComparison <- GetComparison(exampleData,
                              comparisons = list(c("NP0", "NPA"),
                                                              c("NP0", "NPB"),
                                                              c("NPA", "NPB")),
                              type = "glyco")

head(myComparison,5)
  
```

## The GlycoDiveR data format

All GlycoDiveR importers will generate the same data format to make sure all
imported data is directly compatible with all plots. Each importer returns a list
containing the following objects:

- A data frame with PSM level data (acces through: exampleData$PSMTable)
- A data frame where each row is one PTM site (acces through: exampleData$PTMTable)
- The unfiltered dataframe (acces through: exampleData$rawPSMTable)
- The annotation file (acces through: exampleData$annotation)
- The inputted search engine and provided cutoffs

```{r}
data("exampleData")
head(exampleData$PSMTable, 5)
```

The GlycoDiveR dataframes will have all the unfiltered rows, and will only filter 
for the selected cutoffs when GlycoDiveR functions are called, for example, when
plotting. If desired, you can modify the dataframes as long as the formatting remains
the same

## Subsets of peptides or proteins of interest

Often times you want to look at a subset of proteins or peptides. Each GlycoDiveR
plot has a 'whichPeptide' and a 'whichProtein' argument. These will filter for only
the peptides or proteins of interest.

*whichPeptide*:  This can either be a dataframe with a ModifiedPeptide peptide column, 
or a vector with the ModifiedPeptide sequences that you want to keep. Inputted 
data with the comparison importer functions is directly usable, also after filtering 
using the FilterComparison function.

*whichProtein*: These are the IDs as presented in the UniprotIDs column in your 
GlycoDiveR data. This can either be a dataframe with a UniprotIDs column, or a 
vector with the UniprotIDs you want to keep.

This flexible format makes it easy to create and visualize focused subsets of your data.

## GlycoDiveR general plots

Each GlycoDiveR plot has numerous arguments to customize various aspects of the
visualization. Please take the time to look at these arguments for the plots
you are making. Please refer to the wiki on Github to learn how to change the
default color palette.

If you have haven't imported the dataset, please do so to follow along:

```{r}
data("exampleData")
```

### PlotQuantificationQC

Showcase the normalized and raw intensity values.

```{r, message = FALSE, warning = FALSE, fig.width=6, fig.height=4}
PlotQuantificationQC(exampleData, whichQuantification = "both")
```

### PlotPSMCount

The total number of PSMs.

```{r, message = FALSE, fig.width=5, fig.height=4}
PlotPSMCount(exampleData, grouping = "technicalReps")
```

### PlotGlycoPSMCount

The number of glycoPSMs.

```{r, message = FALSE, fig.width=5, fig.height=4}
PlotGlycoPSMCount(exampleData, grouping = "biologicalReps")
```

### PlotGlycopeptideCount

The number of unique glycopeptides.

```{r, message = FALSE, fig.width=5, fig.height=4}
PlotGlycopeptideCount(exampleData, grouping = "condition")
```

### PlotCompletenessMatrix

A matrix showing what (glyco)PSMs were identified in the samples. Provides
insights into your data completeness.

```{r, message = FALSE, fig.width=6, fig.height=6}
PlotCompletenessMatrix(exampleData, peptideType = "glyco", collapseTechReps = FALSE)
```

### PlotPSMsVsTime

The retention time versus the number of identified (glyco)PSMs.

```{r, message = FALSE, fig.width=6, fig.height=4}
PlotPSMsVsTime(exampleData, type = "allGlyco", whichAlias = c("NPA_1_i1"))
```

### PlotGlycositeIdsPerRun

What runs identified specific glycosylation sites.

```{r, message = FALSE, fig.width=6, fig.height=4}
PlotGlycositeIdsPerRun(exampleData, whichProtein = "P00748")
```

### PlotUpSet

An Upset plot to showcase overlap in glycopeptide, glycoprotein, peptide, or
protein overlap.

```{r, message = FALSE, fig.width=6, fig.height=4}
PlotUpSet(exampleData, type = "glyco", level = "protein")
```

### PlotPTMQuantification

An heatmap showing the glycosite quantification for a single protein.

```{r, message = FALSE, fig.width=6, fig.height=7}
PlotPTMQuantification(exampleData, whichProtein = "P12259,A0A0A0MRJ7")
```

### PlotSiteQuantification

Quantification of a single glycosite.

```{r, message = FALSE, fig.width=6, fig.height=4}
PlotSiteQuantification(exampleData, whichProtein = "P12259,A0A0A0MRJ7", site = "N821")
```

### PlotGlycanCompositionPie

The glycan composition of a single protein.

```{r, message = FALSE, fig.width=6, fig.height=4}
PlotGlycanCompositionPie(exampleData, whichProtein = "P12259,A0A0A0MRJ7")
```

### PlotGlycansPerSite

This plot shows how many glycans were detected at each siteâ€”
that is, how many sites have 1 glycan, 2 glycans, and so on.

```{r, message = FALSE, fig.width=5, fig.height=5}
PlotGlycansPerSite(exampleData)
```

### PlotGlycoProteinGlycanNetwork

A network graph where each node in the circle represents one glycan composition,
and each node in the center represents one protein sorted by the number of identified
N-glycan sites.

```{r, message = FALSE, fig.width=7, fig.height=6}
PlotGlycoProteinGlycanNetwork(exampleData)

PlotGlycoProteinGlycanNetwork(exampleData, highlight = "Sialyl+Fucose")
```

### PlotGlycositesVsGlycans

The scatterplot where each dot is a protein, plotted by its number of glycosites 
(x-axis) versus the total number of glycans (y-axis).

```{r, message = FALSE, warning = FALSE, fig.width=6, fig.height=4}
PlotGlycositesVsGlycans(exampleData, labelGlycositeCutoff = 1,
                        labelGlycanCutoff = 5,  alpha = 1)
```

### PlotSiteGlycanComposition

A visualization per protein showing site heterogeneity of all glycosites. It 
automatically overlaps any domain information present on Uniprot.

```{r, message = FALSE, , warning = FALSE, fig.width=6, fig.height=4}
PlotSiteGlycanComposition(exampleData, whichProtein = "P07358")
```

## GlycoDiveR comparison plots

This needs comparison data. Please import MSstats or Perseus data. Or generate 
your comparisons like this. See the "Importing comparison results" section to
see how.

### PlotSiteGlycanComposition

A volcano plot.

```{r, message = FALSE, warning = FALSE, fig.width=6, fig.height=4}
PlotComparisonVolcano(myComparison, whichComparison = c("NPA-NPB"),
                      statistic = "adjpvalue", statisticalCutoff = 0.05)
```

## Compuation functions

GlycoDiveR has in-built functions to compute data statistics.

### ComputeMissingess

This function calculates the percentage of missing quantitative values on the glycopeptide
level, either for all peptides, or for glycopeptides only. This will consider onsider
peptides with an intensity of 0 as a missing quantitative value.

```{r, message = FALSE}
ComputeMissingness(exampleData, type = "all")

ComputeMissingness(exampleData, type = "glyco")
```

### ComputeNumberOfGlycoforms

This computes the potential number of glycoforms based on the identified 
glycans. It will also include the unmodified site for each glycosite. 

```{r, message = FALSE}
ComputeNumberOfGlycoforms(exampleData, whichProtein = "P00734,C9JV37,E9PIT3")
```


## Saving plots

Generated plots can be treated as any other plot, and saved in all the common
formats (pdf, png, svg, etc.). The first option is after running a plotting function:

```{r, eval = FALSE}
ggsave("C:/filename.pdf", width = 7, height = 7)
```

The other option is to stream the plots to one, or more pdf files.

```{r, eval = FALSE}
pdf("C:/filename.pdf", width = 7, height = 7)

Plotfunction1
Plotfunction2
Plotfunction3

dev.off()
```
